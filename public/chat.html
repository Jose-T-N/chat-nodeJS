<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>

    <script type="text/javascript" src="jquery/dist/jquery.js"></script>

    <link rel="stylesheet" href="css/chat.css">

</head>

<body>
    <div class="main">

        <div class="senders-div">
            <ul class="senders">
            </ul>
        </div>


        <form id="chat">
            <div class="header">
                <img src="src/back.png" class="back">
                <img src="src/user-icon.png" class="user-img">
                <h3>Chat com:&nbsp;<span></span></h3>
            </div>
            <div class="messages">
            </div>
            <div class="baseboard">
                <input id="input-img" type="file" style="display: none;">
                <p contenteditable="true" name="message" placeholder="Digite sua menssagem" class="input-message"></p>
                <label for="input-img">
                    <img class="send-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAACXBIWXMAAAsTAAALEwEAmpwYAAABSUlEQVR4nO2VTUoDQRCFP93q6C10aZKl6N6gwQuZuBDBu0j0BMaAeACvMHGTZKVxP1LwBof56x6n3cg8KAhdr/qjuqcr0KnTjw6BNyCpCMsd0FKv2uwls/ZcA03DPMG0A1x7QNMYq8Zb58B7A0DTWADDMvDCo3gJXAE9dWXR19rKoz4uA7uK7oGo5sT2gGmu5hg4ya01Aht0S75LYA58KeyDGim3nYMb9PS34GWm07sa3608+45jL6jKaPeXduq6jgt5JyHAR8rPPcAzefshwLvKbzzAn/JGIcBRA/BH5gtvDe41GJlP8g5CgMfKjzzANv1wjNiCqowrHR16MlW+m8xzWocAJxoKNhzQk5npzjc63rRT8zw69ioo8YBbN1Wy3IPHPgUlHrHWcBjomUX6PXEcb1IH9vl3ahtxGXj4x/AYOCsDd+r0P/QNhsOF+bVhbNEAAAAASUVORK5CYII=">
                </label>
            </div>
            <button type="submit">Enviar</button>
        </form>

        <!--<div class="messages-another-users">
            <div class="another-message"></div>
        </div>-->

    </div>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io();
        var user = localStorage.getItem("user");
        var cont = 0;
        var all_users = [];
        var select = document.getElementById('usersend');
        var idMessage = '';
        var msgOutersUsers = [];
        var contMsg = 0;
        var currentSender = "";

        var states = ['selec-sender', 'messages'];
        var state = states[0];

        socket.emit('page-inform', { page: 'chat', user: user });

        if (user.length == 0 || user === null) {
            $(location).attr('href', 'index.html');
        }

        /**
         * 
         * Evento do input file
         * 
         */
        
        $("#input-img").on('change',()=>{
            readFile();
        })

        //console.log(user);

        //set screen when resize
        window.onresize = function () {
            if (window.innerWidth > 620) {
                $('.senders-div').css('display', 'block');
                $('#chat').css('display', 'block');
            }
            if (window.innerWidth < 620) {
                if (state === states[0]) {
                    $('.senders-div').css('display', 'block');
                    $('#chat').css('display', 'none');
                }
                if (state === states[1]) {
                    $('.senders-div').css('display', 'none');
                    $('#chat').css('display', 'block');
                }
            }
        }

        //back botton
        $('.back').on('click', () => {
            $('.senders-div').css('display', 'block');
            $('#chat').css('display', 'none');

            state = states[0];

        })

        //
        //the function that put messages on the screen
        //
        //
        function renderMessage(message) {
            contMsg++;
            if (message.userID === user) {
                $('.messages').append(
                    '<section class="message-this">' +
                    '<div class="content">' +
                    '<img src="src/user-icon.png"/>' +
                    '<div class="message-box">' +
                    '<div class="message">' + message.message + '</div>' +
                    '</div>' +
                    '<div class="user"> você </div>' +
                    '</div>' +
                    '</section>');
            }
            else {
                $('.messages').append(
                    '<section class="message-another">' +
                    '<div class="content">' +
                    '<img src="src/user-icon.png"/>' +
                    '<div class="message-box">' +
                    '<div class="message">' + message.message + '</div>' +
                    '</div>' +
                    '<div class="user">' + message.userID + '</div>' +
                    '</div>' +
                    '</section>');
            }
            let messagesDiv = document.querySelector('.messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                if(message.userSendID === user && message.message_status == 2){
                    //Muda o status da menssagem com visto
                    newStatus = {id:message.id,status:3}
                    socket.emit('setStatus', newStatus);
                }

        }
        /**---------------//////////////////////////////////////////////-------------------------//-
        //---------------///////Recebe as menssagens do servidor///////-------------------------//-
        /---------------//////////////////////////////////////////////--------------------------/-
        */
        socket.on('messages', function (messages) {
            //console.log("osvijb")
            //console.log(message)
            for (let message of messages) {
                //console.log(message);
                if (user.length != 0) {
                    //case id of message equals to id previous message, so return false
                    //if (message.id !== idMessage) {
                    //console.log(message);
                    if ((message.message.userID === currentSender && message.message.userSendID === user) ||
                        (message.message.userID === user && message.message.userSendID === currentSender)) {
                            if(message.type === "old_message" || message.type === "new_message")
                                renderMessage(message.message);
                            else if(message.type === "old_64_message" || message.type === "new_64_message")
                                renderMessageB64(message.message)
                            
                            //console.log(message.type);
                    }
                    else {
                        /*if(message.status == 1){
                            //Muda o status da menssagem com visto
                            newStatus = {id:message.id,status:2}
                            socket.emit('setStatus', newStatus);
                        }*/
                        anotherMessages(message.message);
                    }
                    idMessage = message.id;
                    //}
                }
                //pos +=1;
            }
        });
        /**
         * ////////////////////////////////////////////////////////////////////////////////////
         * -------------------------////////////////////////////---------------------
        //---///////---Mensssagens de outros remententes (que não é o detinatário original).--/
        //---/////////////////////////////////////////////////////////////////////////////----/
        *//////////////////////////////////////////////////////////////////////////////////////*
        function anotherMessages(message) {
            //caso message for diferente de null
            //então o array msgOuterUsers é preenchido
            if (message !== null) {
                msgOutersUsers.push(message);
            }
            //A div Another-messages e esvasiada
            // $('.another-message').empty();
            //Verifica se a menssagem tem status 1
            //Percorre todos os usuarios
            //Ao achar o remetente iforma quem é
            //console.log(message.message_status)
            if(message != null)
                if(message.message_status == 1 || message.message_status == 2 ){
                    //console.log("123")
                    for (i = 0; i < all_users.length; i++) {
                        //Quando a achar o nome 
                        if (message.userID === all_users[i]) {
                            
                            //Informa novas menssagens

                            let numberMessages = $('div[data-name="'+all_users[i]+'"]').text()
                            //console.log(cont.search(/[0-9]/i))
                            //Esvasia a div
                            $('div[data-name="'+all_users[i]+'"]').empty();
                            //Trasforma numberMessages em inteiro
                            numberMessages = numberMessages.search(/[0-9]/i) > -1 ? Number.parseInt(numberMessages):0; 
                            //Soma a quantidade de menssagens
                            let cont = numberMessages + 1;
                            let html = '<p>'+cont+'</p>'   
                            let selector = '.messages-another-users'
                            $('div[data-name="'+all_users[i]+'"]').css("display","block");
                            $('div[data-name="'+all_users[i]+'"]').append(html)
                            //Muda o status da menssagem com visto
                            if(message.userSendID === user && message.message_status == 1){
                                console.log(message.id);
                                newStatus = {id:message.id,status:2}
                                socket.emit('setStatus', newStatus);
                            }
                        }
                    }
                }   
        }
        //
        //the function that put messages on the screen
        //
        //
        function renderMessageB64(message) {
            //Verifica se a menssagem é do usuário ou do destinatário
            if (message.userID === user) {
                //
                var img = new Image();
                img.className = "file-message";
                img.src = 'data:image/jpg;base64,'+message.message;

                if (message.userID === user) {
                $('.messages').append(
                    '<section class="file-message-this">' +
                    '<div class="content">' +
                    '<div class="message-box">' +
                    '<img class="message" src="data:image/jpg;base64,'+ message.message + '"/>' +
                    '</div>' +
                    '<img src="src/user-icon.png"/>' +
                    '<div class="user"> você </div>' +
                    '</div>' +
                    '</section>');
            }
            else {
                $('.messages').append(
                    '<section class="file-message-another">' +
                    '<div class="content">' +
                    '<img src="src/user-icon.png"/>' +
                    '<div class="message-box">' +
                    '<img class="message" src="data:image/jpg;base64,'+ message.message + '"/>' +
                    '</div>' +
                    '<div class="user">' + message.userID + '</div>' +
                    '</div>' +
                    '</section>');
            }
            }
            else{
                
            }
            //
            //
            //
            let messagesDiv = document.querySelector('.messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            if(message.userSendID === user && message.message_status == 2){
                //Muda o status da menssagem com visto
                newStatus = {id:message.id,status:3}
                socket.emit('setStatus', newStatus);
            }
        }
        /**
         * -------------------//////////////////////////////////////////////////--------------
         * ------///Recebe as menssagens que foram recém enviadas para o servidor--//////--
         * -////////////////////////////////////////////////////////////////////////////-------
         */
         socket.on('send-now', function (message) { 
            //Verifica se pro remetente atual
            console.log(message);
            if ((message.userID === currentSender && message.userSendID === user) ||
                (message.userID === user && message.userSendID === currentSender)){
                    if(message.message_type === "TEXT")
                        renderMessage(message);
                    else {
                        renderMessageB64(message);
                    }
            }
            else {
                anotherMessages(message);
            }
            idMessage = message.id;
        });
        //config the senders section
        socket.on('senders', function (message) {
            $('#usersend').empty();
            let c = 0;
            //create list user and pass to <select>
            //false if user null
            for (message of message) {
                //Tags do remetente
                let html = '<li>'+
                            '<img src="src/user-icon.png" class="img">'
                            +'<h3>' 
                            + message.user 
                            + '</h3>'
                            +'<div class="messages-another-users" data-name="'+message.user+'" style="display: none">'
                            +'<div class="another-message"></div>'
                            +'</div>'
                            +'</li>';
                if (message.user !== user) {
                    $(".senders").append(html);
                    all_users.push(message.user);
                }
            }
            //case alone exists one user
            if ($('.senders li').length == 0) {
                $(".senders").append('<h3 class="msg">Você é o único usuário no banco de dados.&nbsp;' +
                    'Por causa do login automatico você tem que abri uma aba privada ou em outro dispositivo&nbsp;' +
                    'para poder criar outro usúario.</h3 >');
            }
            currentSender = all_users[0];
            $('.senders li').each(function (index) {
                if (index == 0) {
                    $(this).css('background', 'rgba(0, 0, 0, 0.1)');
                }
            })
            $('.header span').append(currentSender);
            $(".senders li").on('click', liClick);
            //Desativa a caixa vermelha de outras menssagens 
        });
        //busca novas menssagens
        socket.on('newsMessages', function (message) {
            //console.log("osvijb")
            for (message of message) {
                //console.log(message)
                if (user.length != 0) {
                    if(message.userSendID === user &&  message.userID !== currentSender ){
                        anotherMessages(message);
                    }
                    else{
                        if(message.message_type === "TEXT")
                            renderMessage(message);
                        else
                            renderMessageB64(message);
                    }
                }
            }
        });
        //when the button submit is click
        $('#chat').submit(function (event) {
            event.preventDefault();

            //captch the digited informations
            var message = $('.input-message').text();
            var usersend = currentSender;

            $('.input-message').on('input', function () {
                
            });

            console.log(message)

            $('.input-message').text('');

            //console.log(usersend);

            //create messagens
            if (user.length && message.length) {
                let messageObject = {
                    userID: user,
                    message: message,
                    userSendID: usersend
                }
                //renderMessage(messageObject);
                socket.emit('sendMessage', messageObject);
            }
        });

        socket.on('new-sender', (message) => {
            alert('novo usuario adicionado');
            if ($('.senders .msg').length > 0) { $(".senders").empty() };
            $(".senders").append('<li><img src="src/user-icon.png" class="img"></div><h3>' + message + '</h3></li>');

            $('.senders li').off('click');
            $('.senders li').on('click', liClick);

        });

        //click event of sendes list
        function liClick() {

            //console.log('sdfg');

            $(".senders li").removeAttr('style');


            $(this).css('background', 'rgba(0, 0, 0, 0.1)');

            $('.messages').empty();
            //Salva o nome do destinatario selecionado
            currentSender = $(this).children("h3").text();
            $('.header span').empty();
            $('.header span').append(currentSender)

            let messageObject = {
                userID: user,
                userSendID: currentSender
            }
            socket.emit('findMessage', messageObject);
            socket.emit('findNewsMessage', messageObject);
            //Esvasia o array de outros usuários
            for (i = 0; i < msgOutersUsers.length; i++) {
                if (msgOutersUsers[i].userID === currentSender) { 
                    msgOutersUsers.splice(i);
                }
            }
            //Tira o aviso de novas menssagens
            $('div[data-name="'+currentSender+'"]').children("P").remove();
            $('div[data-name="'+currentSender+'"]').css('display','none');
            state = states[1];
            //Fecha a parte de remetentes e abre a parte de messagens
            if ($(window).width() < 620) {
                $('.senders-div').css('display', 'none');
                $('#chat').css('display', 'block');

            }

            anotherMessages(null);

        }
        /**
         *Pega a imagem selecionada pelo usuário é trasforma em base64 
         */
        function readFile() {
            
            var file = document.querySelector('input[type=file]')['files'][0];
            var reader = new FileReader();
            var baseString;
            reader.onloadend = function () {
                baseString = reader.result;
                //console.log(baseString);
                let index = baseString.indexOf(",");
                let b64 = baseString.substring(index+1,baseString.length);
                //Pega a extenção da imagem
                index = file.name.lastIndexOf(".");
                let ext = file.name.substring(index,file.name.length);
                //Envia a imagem para o servidor
                const data = {
                    userID: user,
                    userSendID: currentSender,
                    base64: b64,
                    ext: ext
                }
                socket.emit('base64', data);

            };
            reader.readAsDataURL(file);
        }

    </script>


</body>

</html>